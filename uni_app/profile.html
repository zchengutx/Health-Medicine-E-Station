<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户信息管理 - 健康医疗驿站</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .profile-page {
            min-height: 100vh;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .nav-left, .nav-right {
            width: 40px;
            display: flex;
            align-items: center;
        }
        
        .nav-left {
            justify-content: flex-start;
        }
        
        .nav-right {
            justify-content: flex-end;
        }
        
        .back-icon, .more-icon {
            font-size: 20px;
            color: #333;
            cursor: pointer;
        }
        
        .nav-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .section-title {
            padding: 15px 20px 10px;
            font-size: 14px;
            color: #999;
            background: #f5f5f5;
        }
        
        .profile-list {
            background: #fff;
            margin-bottom: 10px;
        }
        
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .profile-item.danger .item-label {
            color: #ff4d4f;
        }
        
        .item-left {
            flex: 1;
        }
        
        .item-label {
            font-size: 15px;
            color: #333;
        }
        
        .item-right {
            display: flex;
            align-items: center;
        }
        
        .item-value {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
        }
        
        .arrow {
            font-size: 16px;
            color: #ccc;
        }
        
                 .avatar {
             width: 40px;
             height: 40px;
             border-radius: 20px;
             margin-right: 10px;
             background: #f0f0f0;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 20px;
             overflow: hidden;
         }
         
         .avatar img {
             width: 100%;
             height: 100%;
             object-fit: cover;
             border-radius: 20px;
         }
        
        .delete-desc {
            padding: 0 20px 15px;
            background: #fff;
        }
        
        .desc-text {
            font-size: 12px;
            color: #999;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="profile-page">
        <!-- 顶部导航 -->
        <div class="nav-header">
            <div class="nav-left" onclick="goBack()">
                <span class="back-icon">‹</span>
            </div>
            <div class="nav-title">用户信息管理</div>
            <div class="nav-right">
                <span class="more-icon">⋯</span>
            </div>
        </div>

        <!-- 用户信息列表 -->
        <div class="profile-list">
            <!-- 头像 -->
                         <div class="profile-item" onclick="changeAvatar()">
                 <div class="item-left">
                     <span class="item-label">头像</span>
                 </div>
                 <div class="item-right">
                     <div class="avatar" id="userAvatar">
                         <img id="avatarImg" src="" alt="头像" style="display: none;">
                         <span id="avatarPlaceholder">👤</span>
                     </div>
                     <span class="arrow">›</span>
                 </div>
             </div>

            <!-- 昵称 -->
            <div class="profile-item" onclick="changeNickname()">
                <div class="item-left">
                    <span class="item-label">昵称</span>
                </div>
                <div class="item-right">
                    <span class="item-value" id="userNickname">未设置</span>
                    <span class="arrow">›</span>
                </div>
            </div>

            <!-- 手机号 -->
            <div class="profile-item" onclick="changePhone()">
                <div class="item-left">
                    <span class="item-label">解绑手机号</span>
                </div>
                <div class="item-right">
                    <span class="item-value" id="userPhone">未绑定</span>
                    <span class="arrow">›</span>
                </div>
            </div>
        </div>

        <!-- 信息管理 -->
        <div class="section-title">信息管理</div>
        <div class="profile-list">
            <div class="profile-item" onclick="handleInfo('inquiry')">
                <div class="item-left">
                    <span class="item-label">个人信息查阅和管理</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('download')">
                <div class="item-left">
                    <span class="item-label">个人信息下载</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>
        </div>

        <!-- 协议和设置 -->
        <div class="section-title">协议和设置</div>
        <div class="profile-list">
            <div class="profile-item" onclick="handleInfo('agreement')">
                <div class="item-left">
                    <span class="item-label">用户协议</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('privacy')">
                <div class="item-left">
                    <span class="item-label">隐私协议</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('payment')">
                <div class="item-left">
                    <span class="item-label">支付密码管理</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>
        </div>

        <!-- 账号管理 -->
        <div class="section-title">账号管理</div>
        <div class="profile-list">
            <div class="profile-item danger" onclick="showDeleteConfirm()">
                <div class="item-left">
                    <span class="item-label">注销账号</span>
                </div>
                <div class="item-right">
                    <span class="arrow">›</span>
                </div>
            </div>
            <div class="delete-desc">
                <span class="desc-text">提交申请、删除所有数据,永久注销账号</span>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时检查登录状态并加载用户信息
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadUserInfo();
        });
        
        // 页面显示时刷新用户信息（用于从编辑页面返回时更新显示）
        window.addEventListener('pageshow', function() {
            loadUserInfo();
        });
        
        // 页面显示时刷新用户信息（用于从编辑页面返回时更新显示）
        window.addEventListener('pageshow', function() {
            loadUserInfo();
        });

        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            if (!token || !userInfo) {
                // 未登录，跳转到登录页
                window.location.href = 'login.html';
            }
        }

        // 加载用户信息
        async function loadUserInfo() {
            // 先从本地存储加载（快速显示）
            const userInfo = localStorage.getItem('userInfo');
                         if (userInfo) {
                 const user = JSON.parse(userInfo);
                 document.getElementById('userNickname').textContent = user.username || '未设置';
                 document.getElementById('userPhone').textContent = maskPhone(user.phone);
                 updateAvatar(user.avatar);
             }
            
            // 然后从后端获取最新信息
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }
                
                console.log('正在从后端获取用户信息...');
                const response = await fetch('http://localhost:8000/v1/userInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({}) // 空的请求体
                });
                
                console.log('后端响应状态:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('后端数据:', data);
                    
                    if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                        // 更新用户信息 - 优先使用服务器数据
                        const serverUserInfo = data.data || data;
                        if (serverUserInfo) {
                            console.log('服务器用户信息:', serverUserInfo);
                            
                            // 处理字段名映射 - 后端返回userName，前端期望username
                            const mappedUserInfo = {
                                username: serverUserInfo.userName || serverUserInfo.username,
                                phone: serverUserInfo.mobile || serverUserInfo.phone,
                                avatar: serverUserInfo.avatar
                            };
                            
                            // 优先使用服务器数据，本地数据作为补充
                            const localUserInfo = localStorage.getItem('userInfo');
                            const localUser = localUserInfo ? JSON.parse(localUserInfo) : {};
                            const mergedUser = { ...localUser, ...mappedUserInfo };
                            
                            // 更新本地存储
                            localStorage.setItem('userInfo', JSON.stringify(mergedUser));
                            
                                                         // 更新页面显示
                             document.getElementById('userNickname').textContent = mergedUser.username || '未设置';
                             document.getElementById('userPhone').textContent = maskPhone(mergedUser.phone);
                             updateAvatar(mergedUser.avatar);
                            
                            console.log('更新后的用户信息:', mergedUser);
                        }
                    } else {
                        console.log('后端返回错误:', data);
                    }
                } else {
                    console.log('HTTP错误:', response.status);
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
                // 如果获取失败，继续使用本地数据
            }
        }

        // 手机号脱敏
        function maskPhone(phone) {
            if (!phone) return '未绑定';
            return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
        }

        // 返回上一页
        function goBack() {
            window.history.back();
        }

        // 修改头像
        function changeAvatar() {
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadAvatar(file);
                }
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // 上传头像
        async function uploadAvatar(file) {
            try {
                // 获取token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('请先登录');
                    return;
                }

                // 显示上传中提示
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                loadingDiv.innerHTML = '<div style="background: white; padding: 20px; border-radius: 10px;">上传中...</div>';
                document.body.appendChild(loadingDiv);

                // 创建FormData
                const formData = new FormData();
                formData.append('file', file);

                // 上传文件
                const response = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': token
                        // 注意：不要设置Content-Type，让浏览器自动设置multipart/form-data
                    },
                    body: formData
                });

                // 移除加载提示
                document.body.removeChild(loadingDiv);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('上传响应:', data);

                // 检查上传结果
                if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                    // 更新本地用户信息
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    
                    let newAvatar = '';
                    if (data.data && data.data.avatar) {
                        newAvatar = data.data.avatar;
                    } else if (data.avatar) {
                        newAvatar = data.avatar;
                    }
                    
                    userInfo.avatar = newAvatar;
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    
                    // 更新页面显示 - 强制刷新
                    updateAvatar(newAvatar);
                    
                    // 强制重新加载用户信息以确保显示更新
                    setTimeout(() => {
                        loadUserInfo();
                    }, 100);
                    
                    alert('头像更新成功');
                    console.log('头像更新成功:', newAvatar);
                } else {
                    throw new Error(data.message || '上传失败');
                }
            } catch (error) {
                console.error('上传头像失败:', error);
                alert(error.message || '上传失败');
            }
        }

        // 修改昵称
        function changeNickname() {
            window.location.href = 'edit-nickname.html';
        }

        // 修改手机号
        function changePhone() {
            if (confirm('确定要解绑当前手机号吗？')) {
                alert('手机号解绑功能开发中');
            }
        }

        // 处理信息管理
        function handleInfo(type) {
            const actions = {
                inquiry: '个人信息查阅和管理',
                download: '个人信息下载',
                agreement: '用户协议',
                privacy: '隐私协议',
                payment: '支付密码管理'
            };
            
            alert(`${actions[type]}功能开发中`);
        }

        // 显示注销确认
        function showDeleteConfirm() {
            if (confirm('确定要注销账号吗？此操作不可恢复，所有数据将被永久删除。')) {
                deleteAccount();
            }
        }

        // 注销账号
        function deleteAccount() {
            alert('注销中...');
            
            setTimeout(() => {
                // 清除本地存储
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                
                alert('账号已注销');
                
                // 跳转到登录页
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }, 2000);
                 }
         
         // 更新头像显示
         function updateAvatar(avatarUrl) {
             const avatarImg = document.getElementById('avatarImg');
             const avatarPlaceholder = document.getElementById('avatarPlaceholder');
             
             console.log('正在更新头像:', avatarUrl);
             
             if (avatarUrl && avatarUrl.trim() !== '') {
                 // 构建完整的头像URL
                 let fullAvatarUrl = avatarUrl;
                 
                 // 如果头像URL不是以http开头，则添加后端服务器地址
                 if (!avatarUrl.startsWith('http')) {
                     fullAvatarUrl = `http://localhost:8000/uploads/${avatarUrl}`;
                 }
                 
                 console.log('完整头像URL:', fullAvatarUrl);
                 
                 // 设置图片源并显示
                 avatarImg.src = fullAvatarUrl;
                 avatarImg.style.display = 'block';
                 avatarPlaceholder.style.display = 'none';
                 
                 // 图片加载失败时显示默认头像
                 avatarImg.onerror = function() {
                     console.log('头像加载失败，显示默认头像');
                     avatarImg.style.display = 'none';
                     avatarPlaceholder.style.display = 'block';
                 };
                 
                 // 图片加载成功时隐藏默认头像
                 avatarImg.onload = function() {
                     console.log('头像加载成功');
                     avatarPlaceholder.style.display = 'none';
                 };
             } else {
                 // 没有头像时显示默认头像
                 console.log('没有头像，显示默认头像');
                 avatarImg.style.display = 'none';
                 avatarPlaceholder.style.display = 'block';
             }
         }
     </script>
</body>
</html>
