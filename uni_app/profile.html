<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ä¿¡æ¯ç®¡ç† - å¥åº·åŒ»ç–—é©¿ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .profile-page {
            min-height: 100vh;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        
        .nav-left, .nav-right {
            width: 40px;
            display: flex;
            align-items: center;
        }
        
        .nav-left {
            justify-content: flex-start;
        }
        
        .nav-right {
            justify-content: flex-end;
        }
        
        .back-icon, .more-icon {
            font-size: 20px;
            color: #333;
            cursor: pointer;
        }
        
        .nav-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .section-title {
            padding: 15px 20px 10px;
            font-size: 14px;
            color: #999;
            background: #f5f5f5;
        }
        
        .profile-list {
            background: #fff;
            margin-bottom: 10px;
        }
        
        .profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .profile-item.danger .item-label {
            color: #ff4d4f;
        }
        
        .item-left {
            flex: 1;
        }
        
        .item-label {
            font-size: 15px;
            color: #333;
        }
        
        .item-right {
            display: flex;
            align-items: center;
        }
        
        .item-value {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
        }
        
        .arrow {
            font-size: 16px;
            color: #ccc;
        }
        
                 .avatar {
             width: 40px;
             height: 40px;
             border-radius: 20px;
             margin-right: 10px;
             background: #f0f0f0;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 20px;
             overflow: hidden;
         }
         
         .avatar img {
             width: 100%;
             height: 100%;
             object-fit: cover;
             border-radius: 20px;
         }
        
        .delete-desc {
            padding: 0 20px 15px;
            background: #fff;
        }
        
        .desc-text {
            font-size: 12px;
            color: #999;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="profile-page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="nav-header">
            <div class="nav-left" onclick="goBack()">
                <span class="back-icon">â€¹</span>
            </div>
            <div class="nav-title">ç”¨æˆ·ä¿¡æ¯ç®¡ç†</div>
            <div class="nav-right">
                <span class="more-icon">â‹¯</span>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ -->
        <div class="profile-list">
            <!-- å¤´åƒ -->
                         <div class="profile-item" onclick="changeAvatar()">
                 <div class="item-left">
                     <span class="item-label">å¤´åƒ</span>
                 </div>
                 <div class="item-right">
                     <div class="avatar" id="userAvatar">
                         <img id="avatarImg" src="" alt="å¤´åƒ" style="display: none;">
                         <span id="avatarPlaceholder">ğŸ‘¤</span>
                     </div>
                     <span class="arrow">â€º</span>
                 </div>
             </div>

            <!-- æ˜µç§° -->
            <div class="profile-item" onclick="changeNickname()">
                <div class="item-left">
                    <span class="item-label">æ˜µç§°</span>
                </div>
                <div class="item-right">
                    <span class="item-value" id="userNickname">æœªè®¾ç½®</span>
                    <span class="arrow">â€º</span>
                </div>
            </div>

            <!-- æ‰‹æœºå· -->
            <div class="profile-item" onclick="changePhone()">
                <div class="item-left">
                    <span class="item-label">è§£ç»‘æ‰‹æœºå·</span>
                </div>
                <div class="item-right">
                    <span class="item-value" id="userPhone">æœªç»‘å®š</span>
                    <span class="arrow">â€º</span>
                </div>
            </div>
        </div>

        <!-- ä¿¡æ¯ç®¡ç† -->
        <div class="section-title">ä¿¡æ¯ç®¡ç†</div>
        <div class="profile-list">
            <div class="profile-item" onclick="handleInfo('inquiry')">
                <div class="item-left">
                    <span class="item-label">ä¸ªäººä¿¡æ¯æŸ¥é˜…å’Œç®¡ç†</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('download')">
                <div class="item-left">
                    <span class="item-label">ä¸ªäººä¿¡æ¯ä¸‹è½½</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>
        </div>

        <!-- åè®®å’Œè®¾ç½® -->
        <div class="section-title">åè®®å’Œè®¾ç½®</div>
        <div class="profile-list">
            <div class="profile-item" onclick="handleInfo('agreement')">
                <div class="item-left">
                    <span class="item-label">ç”¨æˆ·åè®®</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('privacy')">
                <div class="item-left">
                    <span class="item-label">éšç§åè®®</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>

            <div class="profile-item" onclick="handleInfo('payment')">
                <div class="item-left">
                    <span class="item-label">æ”¯ä»˜å¯†ç ç®¡ç†</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>
        </div>

        <!-- è´¦å·ç®¡ç† -->
        <div class="section-title">è´¦å·ç®¡ç†</div>
        <div class="profile-list">
            <div class="profile-item danger" onclick="showDeleteConfirm()">
                <div class="item-left">
                    <span class="item-label">æ³¨é”€è´¦å·</span>
                </div>
                <div class="item-right">
                    <span class="arrow">â€º</span>
                </div>
            </div>
            <div class="delete-desc">
                <span class="desc-text">æäº¤ç”³è¯·ã€åˆ é™¤æ‰€æœ‰æ•°æ®,æ°¸ä¹…æ³¨é”€è´¦å·</span>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadUserInfo();
        });
        
        // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºä»ç¼–è¾‘é¡µé¢è¿”å›æ—¶æ›´æ–°æ˜¾ç¤ºï¼‰
        window.addEventListener('pageshow', function() {
            loadUserInfo();
        });
        
        // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºä»ç¼–è¾‘é¡µé¢è¿”å›æ—¶æ›´æ–°æ˜¾ç¤ºï¼‰
        window.addEventListener('pageshow', function() {
            loadUserInfo();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            if (!token || !userInfo) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
            }
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            // å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
            const userInfo = localStorage.getItem('userInfo');
                         if (userInfo) {
                 const user = JSON.parse(userInfo);
                 document.getElementById('userNickname').textContent = user.username || 'æœªè®¾ç½®';
                 document.getElementById('userPhone').textContent = maskPhone(user.phone);
                 updateAvatar(user.avatar);
             }
            
            // ç„¶åä»åç«¯è·å–æœ€æ–°ä¿¡æ¯
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }
                
                console.log('æ­£åœ¨ä»åç«¯è·å–ç”¨æˆ·ä¿¡æ¯...');
                const response = await fetch('http://localhost:8000/v1/userInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({}) // ç©ºçš„è¯·æ±‚ä½“
                });
                
                console.log('åç«¯å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('åç«¯æ•°æ®:', data);
                    
                    if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ - ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨æ•°æ®
                        const serverUserInfo = data.data || data;
                        if (serverUserInfo) {
                            console.log('æœåŠ¡å™¨ç”¨æˆ·ä¿¡æ¯:', serverUserInfo);
                            
                            // å¤„ç†å­—æ®µåæ˜ å°„ - åç«¯è¿”å›userNameï¼Œå‰ç«¯æœŸæœ›username
                            const mappedUserInfo = {
                                username: serverUserInfo.userName || serverUserInfo.username,
                                phone: serverUserInfo.mobile || serverUserInfo.phone,
                                avatar: serverUserInfo.avatar
                            };
                            
                            // ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨æ•°æ®ï¼Œæœ¬åœ°æ•°æ®ä½œä¸ºè¡¥å……
                            const localUserInfo = localStorage.getItem('userInfo');
                            const localUser = localUserInfo ? JSON.parse(localUserInfo) : {};
                            const mergedUser = { ...localUser, ...mappedUserInfo };
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('userInfo', JSON.stringify(mergedUser));
                            
                                                         // æ›´æ–°é¡µé¢æ˜¾ç¤º
                             document.getElementById('userNickname').textContent = mergedUser.username || 'æœªè®¾ç½®';
                             document.getElementById('userPhone').textContent = maskPhone(mergedUser.phone);
                             updateAvatar(mergedUser.avatar);
                            
                            console.log('æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯:', mergedUser);
                        }
                    } else {
                        console.log('åç«¯è¿”å›é”™è¯¯:', data);
                    }
                } else {
                    console.log('HTTPé”™è¯¯:', response.status);
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // å¦‚æœè·å–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®
            }
        }

        // æ‰‹æœºå·è„±æ•
        function maskPhone(phone) {
            if (!phone) return 'æœªç»‘å®š';
            return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.history.back();
        }

        // ä¿®æ”¹å¤´åƒ
        function changeAvatar() {
            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadAvatar(file);
                }
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // ä¸Šä¼ å¤´åƒ
        async function uploadAvatar(file) {
            try {
                // è·å–token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }

                // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                loadingDiv.innerHTML = '<div style="background: white; padding: 20px; border-radius: 10px;">ä¸Šä¼ ä¸­...</div>';
                document.body.appendChild(loadingDiv);

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('file', file);

                // ä¸Šä¼ æ–‡ä»¶
                const response = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': token
                        // æ³¨æ„ï¼šä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®multipart/form-data
                    },
                    body: formData
                });

                // ç§»é™¤åŠ è½½æç¤º
                document.body.removeChild(loadingDiv);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('ä¸Šä¼ å“åº”:', data);

                // æ£€æŸ¥ä¸Šä¼ ç»“æœ
                if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    
                    let newAvatar = '';
                    if (data.data && data.data.avatar) {
                        newAvatar = data.data.avatar;
                    } else if (data.avatar) {
                        newAvatar = data.avatar;
                    }
                    
                    userInfo.avatar = newAvatar;
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º - å¼ºåˆ¶åˆ·æ–°
                    updateAvatar(newAvatar);
                    
                    // å¼ºåˆ¶é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯ä»¥ç¡®ä¿æ˜¾ç¤ºæ›´æ–°
                    setTimeout(() => {
                        loadUserInfo();
                    }, 100);
                    
                    alert('å¤´åƒæ›´æ–°æˆåŠŸ');
                    console.log('å¤´åƒæ›´æ–°æˆåŠŸ:', newAvatar);
                } else {
                    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
                alert(error.message || 'ä¸Šä¼ å¤±è´¥');
            }
        }

        // ä¿®æ”¹æ˜µç§°
        function changeNickname() {
            window.location.href = 'edit-nickname.html';
        }

        // ä¿®æ”¹æ‰‹æœºå·
        function changePhone() {
            if (confirm('ç¡®å®šè¦è§£ç»‘å½“å‰æ‰‹æœºå·å—ï¼Ÿ')) {
                alert('æ‰‹æœºå·è§£ç»‘åŠŸèƒ½å¼€å‘ä¸­');
            }
        }

        // å¤„ç†ä¿¡æ¯ç®¡ç†
        function handleInfo(type) {
            const actions = {
                inquiry: 'ä¸ªäººä¿¡æ¯æŸ¥é˜…å’Œç®¡ç†',
                download: 'ä¸ªäººä¿¡æ¯ä¸‹è½½',
                agreement: 'ç”¨æˆ·åè®®',
                privacy: 'éšç§åè®®',
                payment: 'æ”¯ä»˜å¯†ç ç®¡ç†'
            };
            
            alert(`${actions[type]}åŠŸèƒ½å¼€å‘ä¸­`);
        }

        // æ˜¾ç¤ºæ³¨é”€ç¡®è®¤
        function showDeleteConfirm() {
            if (confirm('ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚')) {
                deleteAccount();
            }
        }

        // æ³¨é”€è´¦å·
        function deleteAccount() {
            alert('æ³¨é”€ä¸­...');
            
            setTimeout(() => {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('token');
                localStorage.removeItem('userInfo');
                
                alert('è´¦å·å·²æ³¨é”€');
                
                // è·³è½¬åˆ°ç™»å½•é¡µ
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }, 2000);
                 }
         
         // æ›´æ–°å¤´åƒæ˜¾ç¤º
         function updateAvatar(avatarUrl) {
             const avatarImg = document.getElementById('avatarImg');
             const avatarPlaceholder = document.getElementById('avatarPlaceholder');
             
             console.log('æ­£åœ¨æ›´æ–°å¤´åƒ:', avatarUrl);
             
             if (avatarUrl && avatarUrl.trim() !== '') {
                 // æ„å»ºå®Œæ•´çš„å¤´åƒURL
                 let fullAvatarUrl = avatarUrl;
                 
                 // å¦‚æœå¤´åƒURLä¸æ˜¯ä»¥httpå¼€å¤´ï¼Œåˆ™æ·»åŠ åç«¯æœåŠ¡å™¨åœ°å€
                 if (!avatarUrl.startsWith('http')) {
                     fullAvatarUrl = `http://localhost:8000/uploads/${avatarUrl}`;
                 }
                 
                 console.log('å®Œæ•´å¤´åƒURL:', fullAvatarUrl);
                 
                 // è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤º
                 avatarImg.src = fullAvatarUrl;
                 avatarImg.style.display = 'block';
                 avatarPlaceholder.style.display = 'none';
                 
                 // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
                 avatarImg.onerror = function() {
                     console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
                     avatarImg.style.display = 'none';
                     avatarPlaceholder.style.display = 'block';
                 };
                 
                 // å›¾ç‰‡åŠ è½½æˆåŠŸæ—¶éšè—é»˜è®¤å¤´åƒ
                 avatarImg.onload = function() {
                     console.log('å¤´åƒåŠ è½½æˆåŠŸ');
                     avatarPlaceholder.style.display = 'none';
                 };
             } else {
                 // æ²¡æœ‰å¤´åƒæ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
                 console.log('æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
                 avatarImg.style.display = 'none';
                 avatarPlaceholder.style.display = 'block';
             }
         }
     </script>
</body>
</html>
