<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å®å½“ - å¥åº·åŒ»ç–—é©¿ç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .user-page {
            min-height: 100vh;
        }
        
        .user-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
                 .avatar {
             width: 60px;
             height: 60px;
             border-radius: 30px;
             background-color: #fff;
             margin-right: 15px;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 24px;
             overflow: hidden;
         }
         
         .avatar img {
             width: 100%;
             height: 100%;
             object-fit: cover;
             border-radius: 30px;
         }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .username {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .user-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .guide-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .member-section {
            margin: 20px;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
        }
        
        .member-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .member-info {
            display: flex;
            align-items: center;
        }
        
        .crown {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .member-text {
            font-size: 14px;
            font-weight: bold;
        }
        
        .member-mall {
            font-size: 12px;
            color: #ccc;
        }
        
        .benefits-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .benefit-item {
            text-align: center;
            position: relative;
            cursor: pointer;
        }
        
        .benefit-number {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .benefit-label {
            display: block;
            font-size: 12px;
            color: #666;
        }
        
        .benefit-tag {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4f;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 5px;
        }
        
        .quick-access {
            margin: 20px;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .quick-item {
            text-align: center;
            cursor: pointer;
        }
        
        .quick-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 8px;
        }
        
        .quick-icon.signin {
            background: #ff6b6b;
        }
        
        .quick-icon.share {
            background: #4ecdc4;
        }
        
        .quick-icon.gift {
            background: #45b7d1;
        }
        
        .quick-icon.frequent {
            background: #96ceb4;
        }
        
        .quick-label {
            font-size: 12px;
            color: #333;
        }
        
        .order-section {
            margin: 20px;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .section-more {
            font-size: 12px;
            color: #999;
            cursor: pointer;
        }
        
        .order-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
        }
        
        .order-item {
            text-align: center;
            cursor: pointer;
        }
        
        .order-icon {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 auto 8px;
        }
        
        .order-label {
            font-size: 12px;
            color: #333;
        }
        
        .service-section {
            margin: 20px;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
        }
        
        .service-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .service-item {
            text-align: center;
            cursor: pointer;
        }
        
        .service-icon {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 auto 8px;
        }
        
        .service-label {
            font-size: 12px;
            color: #333;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="user-page">
        <button class="back-btn" onclick="goBack()">è¿”å›</button>
        
        <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-header">
                         <div class="user-info" onclick="goToProfile()">
                 <div class="avatar" id="userAvatar">
                     <img id="avatarImg" src="" alt="å¤´åƒ" style="display: none;">
                     <span id="avatarPlaceholder">ğŸ‘¤</span>
                 </div>
                 <div class="user-details">
                     <div class="username" id="username">åŠ è½½ä¸­...</div>
                     <div class="user-desc" id="userPhone">åŠ è½½ä¸­...</div>
                 </div>
             </div>
            <button class="guide-btn">è¯å¸ˆæŒ‡å¯¼â–¶</button>
        </div>

        <!-- ä¼šå‘˜ä¿¡æ¯ -->
        <div class="member-section">
            <div class="member-card">
                <div class="member-info">
                    <span class="crown">ğŸ‘‘</span>
                    <span class="member-text">æ³¨å†Œä¼šå‘˜</span>
                </div>
                <span class="member-mall">ä¼šå‘˜å•†åŸ ></span>
            </div>
            
            <div class="benefits-grid">
                <div class="benefit-item" onclick="handleBenefit('coupon')">
                    <span class="benefit-number">11</span>
                    <span class="benefit-label">ä¼˜æƒ åˆ¸</span>
                    <span class="benefit-tag">é¢†å¥½åˆ¸</span>
                </div>
                <div class="benefit-item" onclick="handleBenefit('coin')">
                    <span class="benefit-number">10</span>
                    <span class="benefit-label">å®å½“å¸</span>
                    <span class="benefit-tag">èµšå¸</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-number">0</span>
                    <span class="benefit-label">æˆé•¿å€¼</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-number">0.00</span>
                    <span class="benefit-label">å¥åº·å¡(å…ƒ)</span>
                </div>
            </div>
        </div>

        <!-- å¿«æ·åŠŸèƒ½ -->
        <div class="quick-access">
            <div class="quick-item" onclick="handleQuickAccess('signin')">
                <div class="quick-icon signin">ğŸ“…</div>
                <div class="quick-label">ç­¾åˆ°æœ‰ç¤¼</div>
            </div>
            <div class="quick-item" onclick="handleQuickAccess('share')">
                <div class="quick-icon share">ğŸ</div>
                <div class="quick-label">åˆ†äº«é¢†åˆ¸</div>
            </div>
            <div class="quick-item" onclick="handleQuickAccess('gift')">
                <div class="quick-icon gift">ğŸ’Œ</div>
                <div class="quick-label">çœé’±ç¤¼åŒ…</div>
            </div>
            <div class="quick-item" onclick="handleQuickAccess('frequent')">
                <div class="quick-icon frequent">ğŸ›ï¸</div>
                <div class="quick-label">å¸¸è´­æ¸…å•</div>
            </div>
        </div>

        <!-- æˆ‘çš„è®¢å• -->
        <div class="order-section">
            <div class="section-header">
                <div class="section-title">æˆ‘çš„è®¢å•</div>
                <div class="section-more" onclick="goToOrders()">å…¨éƒ¨è®¢å• ></div>
            </div>
            <div class="order-grid">
                <div class="order-item" onclick="goToOrderStatus('pending')">
                    <div class="order-icon">ğŸ’°</div>
                    <div class="order-label">å¾…ä»˜æ¬¾</div>
                </div>
                <div class="order-item" onclick="goToOrderStatus('shipping')">
                    <div class="order-icon">ğŸ“¦</div>
                    <div class="order-label">å¾…å‘è´§</div>
                </div>
                <div class="order-item" onclick="goToOrderStatus('receiving')">
                    <div class="order-icon">ğŸšš</div>
                    <div class="order-label">å¾…æ”¶è´§</div>
                </div>
                <div class="order-item" onclick="goToOrderStatus('review')">
                    <div class="order-icon">ğŸ’¬</div>
                    <div class="order-label">å¾…è¯„ä»·</div>
                </div>
            </div>
        </div>

        <!-- æœåŠ¡åŠŸèƒ½ -->
        <div class="service-section">
            <div class="service-grid">
                <div class="service-item" onclick="handleService('consultation')">
                    <div class="service-icon">ğŸ‘¨â€âš•ï¸</div>
                    <div class="service-label">åŒ»ç”Ÿé—®è¯Š</div>
                </div>
                <div class="service-item" onclick="handleService('prescription')">
                    <div class="service-icon">ğŸ“‹</div>
                    <div class="service-label">æˆ‘çš„å¤„æ–¹</div>
                </div>
                <div class="service-item" onclick="handleService('patient')">
                    <div class="service-icon">ğŸ‘¤</div>
                    <div class="service-label">å°±è¯Šäºº</div>
                </div>
                <div class="service-item" onclick="handleService('address')">
                    <div class="service-icon">ğŸ“</div>
                    <div class="service-label">åœ°å€ç®¡ç†</div>
                </div>
                <div class="service-item" onclick="handleService('turntable')">
                    <div class="service-icon">ğŸ¡</div>
                    <div class="service-label">å¤§è½¬ç›˜</div>
                </div>
                <div class="service-item" onclick="handleService('slot')">
                    <div class="service-icon">ğŸ¯</div>
                    <div class="service-label">è€è™æœº</div>
                </div>
                <div class="service-item" onclick="handleService('allergy')">
                    <div class="service-icon">âš ï¸</div>
                    <div class="service-label">è¿‡æ•æŒ‡æ•°</div>
                </div>
                <div class="service-item" onclick="handleService('mall')">
                    <div class="service-icon">ğŸª</div>
                    <div class="service-label">å®å½“å¸å•†åŸ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadUserInfo();
        });
        
        // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºä»å…¶ä»–é¡µé¢è¿”å›æ—¶æ›´æ–°æ˜¾ç¤ºï¼‰
        window.addEventListener('pageshow', function() {
            loadUserInfo();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            
            if (!token || !userInfo) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = 'login.html';
            }
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            console.log('=== å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯ ===');
            
            // å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
            const userInfo = localStorage.getItem('userInfo');
            console.log('æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯:', userInfo);
            
                         if (userInfo) {
                 const user = JSON.parse(userInfo);
                 console.log('è§£æåçš„æœ¬åœ°ç”¨æˆ·ä¿¡æ¯:', user);
                 document.getElementById('username').textContent = user.username || 'æœªè®¾ç½®';
                 document.getElementById('userPhone').textContent = user.phone || 'æœªè®¾ç½®';
                 updateAvatar(user.avatar);
                 console.log('é¡µé¢æ˜¾ç¤ºå·²æ›´æ–°ä¸ºæœ¬åœ°æ•°æ®');
             }
            
            // ç„¶åä»åç«¯è·å–æœ€æ–°ä¿¡æ¯
            try {
                const token = localStorage.getItem('token');
                console.log('å½“å‰token:', token);
                
                if (!token) {
                    console.log('æ²¡æœ‰tokenï¼Œè·³è¿‡åç«¯è¯·æ±‚');
                    return;
                }
                
                console.log('æ­£åœ¨ä»åç«¯è·å–ç”¨æˆ·ä¿¡æ¯...');
                const response = await fetch('http://localhost:8000/v1/userInfo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({}) // ç©ºçš„è¯·æ±‚ä½“
                });
                
                console.log('åç«¯å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('åç«¯è¿”å›çš„å®Œæ•´æ•°æ®:', data);
                    
                    if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ - ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨æ•°æ®
                        const serverUserInfo = data.data || data;
                        console.log('æå–çš„æœåŠ¡å™¨ç”¨æˆ·ä¿¡æ¯:', serverUserInfo);
                        
                        if (serverUserInfo) {
                            // å¤„ç†å­—æ®µåæ˜ å°„ - åç«¯è¿”å›userNameï¼Œå‰ç«¯æœŸæœ›username
                            const mappedUserInfo = {
                                username: serverUserInfo.userName || serverUserInfo.username,
                                phone: serverUserInfo.mobile || serverUserInfo.phone,
                                avatar: serverUserInfo.avatar
                            };
                            console.log('å­—æ®µæ˜ å°„åçš„ç”¨æˆ·ä¿¡æ¯:', mappedUserInfo);
                            
                            // ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨æ•°æ®ï¼Œæœ¬åœ°æ•°æ®ä½œä¸ºè¡¥å……
                            const localUserInfo = localStorage.getItem('userInfo');
                            const localUser = localUserInfo ? JSON.parse(localUserInfo) : {};
                            const mergedUser = { ...localUser, ...mappedUserInfo };
                            console.log('åˆå¹¶åçš„ç”¨æˆ·ä¿¡æ¯:', mergedUser);
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('userInfo', JSON.stringify(mergedUser));
                            console.log('æœ¬åœ°å­˜å‚¨å·²æ›´æ–°');
                            
                                                         // æ›´æ–°é¡µé¢æ˜¾ç¤º
                             document.getElementById('username').textContent = mergedUser.username || 'æœªè®¾ç½®';
                             document.getElementById('userPhone').textContent = mergedUser.phone || 'æœªè®¾ç½®';
                             updateAvatar(mergedUser.avatar);
                             console.log('é¡µé¢æ˜¾ç¤ºå·²æ›´æ–°ä¸ºæœåŠ¡å™¨æ•°æ®');
                             console.log('æœ€ç»ˆæ˜¾ç¤ºçš„ç”¨æˆ·å:', mergedUser.username);
                             console.log('æœ€ç»ˆæ˜¾ç¤ºçš„æ‰‹æœºå·:', mergedUser.phone);
                             console.log('æœ€ç»ˆæ˜¾ç¤ºçš„å¤´åƒ:', mergedUser.avatar);
                        }
                    } else {
                        console.log('åç«¯è¿”å›é”™è¯¯:', data);
                    }
                } else {
                    console.log('HTTPé”™è¯¯:', response.status);
                    const errorText = await response.text();
                    console.log('é”™è¯¯è¯¦æƒ…:', errorText);
                }
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                // å¦‚æœè·å–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®
            }
            
                     console.log('=== ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ ===');
     }
     
     // æ›´æ–°å¤´åƒæ˜¾ç¤º
     function updateAvatar(avatarUrl) {
         const avatarImg = document.getElementById('avatarImg');
         const avatarPlaceholder = document.getElementById('avatarPlaceholder');
         
         console.log('æ­£åœ¨æ›´æ–°å¤´åƒ:', avatarUrl);
         
         if (avatarUrl && avatarUrl.trim() !== '') {
             // æ„å»ºå®Œæ•´çš„å¤´åƒURL
             let fullAvatarUrl = avatarUrl;
             
             // å¦‚æœå¤´åƒURLä¸æ˜¯ä»¥httpå¼€å¤´ï¼Œåˆ™æ·»åŠ åç«¯æœåŠ¡å™¨åœ°å€
             if (!avatarUrl.startsWith('http')) {
                 fullAvatarUrl = `http://localhost:8000/uploads/${avatarUrl}`;
             }
             
             console.log('å®Œæ•´å¤´åƒURL:', fullAvatarUrl);
             
             // è®¾ç½®å›¾ç‰‡æºå¹¶æ˜¾ç¤º
             avatarImg.src = fullAvatarUrl;
             avatarImg.style.display = 'block';
             avatarPlaceholder.style.display = 'none';
             
             // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
             avatarImg.onerror = function() {
                 console.log('å¤´åƒåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
                 avatarImg.style.display = 'none';
                 avatarPlaceholder.style.display = 'block';
             };
             
             // å›¾ç‰‡åŠ è½½æˆåŠŸæ—¶éšè—é»˜è®¤å¤´åƒ
             avatarImg.onload = function() {
                 console.log('å¤´åƒåŠ è½½æˆåŠŸ');
                 avatarPlaceholder.style.display = 'none';
             };
         } else {
             // æ²¡æœ‰å¤´åƒæ—¶æ˜¾ç¤ºé»˜è®¤å¤´åƒ
             console.log('æ²¡æœ‰å¤´åƒï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ');
             avatarImg.style.display = 'none';
             avatarPlaceholder.style.display = 'block';
         }
     }

        // è¿”å›é¦–é¡µ
        function goBack() {
            window.location.href = 'index.html';
        }

        // è·³è½¬åˆ°ç”¨æˆ·ä¿¡æ¯ç®¡ç†é¡µé¢
        function goToProfile() {
            window.location.href = 'profile.html';
        }

        // å¤„ç†ä¼šå‘˜ç¦åˆ©
        function handleBenefit(type) {
            alert(`${type}åŠŸèƒ½å¼€å‘ä¸­`);
        }

        // å¤„ç†å¿«æ·åŠŸèƒ½
        function handleQuickAccess(type) {
            alert(`${type}åŠŸèƒ½å¼€å‘ä¸­`);
        }

        // è·³è½¬åˆ°è®¢å•é¡µé¢
        function goToOrders() {
            alert('è®¢å•é¡µé¢å¼€å‘ä¸­');
        }

        // è·³è½¬åˆ°è®¢å•çŠ¶æ€é¡µé¢
        function goToOrderStatus(status) {
            alert(`${status}è®¢å•é¡µé¢å¼€å‘ä¸­`);
        }

        // å¤„ç†æœåŠ¡åŠŸèƒ½
        function handleService(type) {
            alert(`${type}åŠŸèƒ½å¼€å‘ä¸­`);
        }
    </script>
</body>
</html>
