<!DOCTYPE html>
<html>
<head>
    <title>å¤´åƒæµ‹è¯•</title>
    <style>
        .avatar { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #ddd; }
        .info { margin: 10px 0; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>å¤´åƒæ˜¾ç¤ºæµ‹è¯•</h1>
    <div class="avatar" id="avatarDisplay">ğŸ‘¤</div>
    <div class="info" id="info">æœªè®¾ç½®å¤´åƒ</div>
    <button onclick="checkToken()">æ£€æŸ¥Token</button>
    <button onclick="loadUserInfo()">åŠ è½½ç”¨æˆ·ä¿¡æ¯</button>
    <button onclick="uploadAvatar()">ä¸Šä¼ å¤´åƒ</button>
    
    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('info').textContent = msg;
        }
        
        function updateAvatar(avatarUrl) {
            const display = document.getElementById('avatarDisplay');
            if (avatarUrl && avatarUrl.trim() !== '') {
                const fullUrl = avatarUrl.startsWith('http') ? avatarUrl : `http://localhost:8888/uploads/${avatarUrl}`;
                display.innerHTML = `<img src="${fullUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                log(`å¤´åƒå·²æ›´æ–°: ${avatarUrl}`);
            } else {
                display.innerHTML = 'ğŸ‘¤';
                log('æ˜¾ç¤ºé»˜è®¤å¤´åƒ');
            }
        }
        
        function checkToken() {
            const token = localStorage.getItem('token');
            log(token ? `Tokenå­˜åœ¨: ${token.substring(0,20)}...` : 'Tokenä¸å­˜åœ¨');
        }
        
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                if (!token) { log('è¯·å…ˆç™»å½•'); return; }
                
                const response = await fetch('http://localhost:8888/v1/userInfo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                log(`åç«¯å“åº”: ${JSON.stringify(data)}`);
                
                if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                    const userInfo = data.data || data;
                    if (userInfo.avatar) {
                        updateAvatar(userInfo.avatar);
                    }
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`);
            }
        }
        
        function uploadAvatar() {
            const token = localStorage.getItem('token');
            if (!token) { log('è¯·å…ˆç™»å½•'); return; }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const response = await fetch('http://localhost:8888/upload', {
                            method: 'POST',
                            headers: { 'Authorization': token },
                            body: formData
                        });
                        
                        const data = await response.json();
                        log(`ä¸Šä¼ å“åº”: ${JSON.stringify(data)}`);
                        
                        if (data.success || data.code === 0 || (data.message && data.message.includes('success'))) {
                            const newAvatar = data.data?.avatar || data.avatar;
                            if (newAvatar) {
                                updateAvatar(newAvatar);
                                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                                userInfo.avatar = newAvatar;
                                localStorage.setItem('userInfo', JSON.stringify(userInfo));
                            }
                        }
                    } catch (error) {
                        log(`ä¸Šä¼ å¤±è´¥: ${error.message}`);
                    }
                }
            };
            input.click();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°å­˜å‚¨
        document.addEventListener('DOMContentLoaded', () => {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                const user = JSON.parse(userInfo);
                if (user.avatar) {
                    updateAvatar(user.avatar);
                }
            }
        });
    </script>
</body>
</html>
