# 药品搜索系统实现计划

- [x] 1. 设置项目基础设施和依赖



  - 添加Elasticsearch和相关Go客户端依赖到go.mod
  - 配置Elasticsearch连接参数到配置文件
  - 创建Elasticsearch客户端初始化代码
  - _需求: 1.1, 7.1_



- [ ] 2. 扩展药品数据模型
  - [ ] 2.1 扩展MtDrug结构体添加搜索相关字段
    - 在biz/drug.go中为MtDrug添加Keywords、Symptoms、IsPrescription等字段
    - 更新对应的数据库表结构迁移脚本
    - _需求: 1.2, 7.1_

  - [ ] 2.2 创建Elasticsearch文档模型
    - 创建DrugDocument结构体用于ES索引
    - 实现MtDrug到DrugDocument的转换方法

    - 定义ES索引映射配置
    - _需求: 1.1, 1.2_

- [ ] 3. 实现Elasticsearch集成
  - [ ] 3.1 创建ES客户端和基础操作

    - 在data/data.go中添加ES客户端初始化
    - 创建ES索引管理方法(创建、删除、更新映射)
    - 实现基础的文档CRUD操作
    - _需求: 1.1_

  - [ ] 3.2 实现药品数据同步到ES
    - 创建SyncDrugToES方法同步单个药品
    - 实现BulkSyncDrugsToES批量同步方法
    - 添加数据变更时的自动同步逻辑
    - _需求: 1.2, 7.1_

  - [ ] 3.3 实现ES搜索功能
    - 创建SearchRepo接口和实现
    - 实现基础关键词搜索功能
    - 添加分类、价格范围、库存等过滤条件
    - 实现搜索结果排序和分页
    - _需求: 1.3, 1.4_

- [ ] 4. 实现Redis热门搜索统计
  - [ ] 4.1 创建搜索统计基础设施
    - 设计Redis键命名规范和数据结构
    - 创建SearchStatsRepo接口和基础实现
    - 实现搜索记录的INCR计数功能
    - _需求: 2.1, 2.2_

  - [ ] 4.2 实现热门搜索算法
    - 实现基于时间衰减的热度计算算法
    - 创建热门关键词排行榜更新逻辑
    - 实现GetHotKeywords方法返回热门搜索
    - _需求: 2.2, 2.3_

  - [ ] 4.3 实现症状搜索发现功能
    - 创建症状关键词识别和统计逻辑
    - 实现GetHotSymptoms方法
    - 添加症状到药品的关联查询
    - _需求: 3.1, 3.2, 3.3_

  - [ ] 4.4 实现热搜榜单功能
    - 创建用户问题统计机制
    - 实现问题去重和计数逻辑
    - 创建GetHotQuestions方法返回热门问题
    - _需求: 4.1, 4.2, 4.3_

- [ ] 5. 实现处方药管理系统
  - [ ] 5.1 创建处方数据模型和表结构
    - 创建Prescription结构体和数据库表
    - 实现PrescriptionRepo接口
    - 添加处方状态枚举和相关常量
    - _需求: 5.1, 5.2_

  - [ ] 5.2 实现处方上传和管理功能
    - 创建CreatePrescription方法处理处方上传
    - 实现GetPrescription和ListUserPrescriptions查询方法
    - 添加处方图片存储和访问逻辑
    - _需求: 5.1, 5.4_

  - [ ] 5.3 实现处方审核功能
    - 创建UpdatePrescriptionStatus审核方法
    - 实现ListPendingPrescriptions获取待审核列表
    - 添加审核通知和状态变更逻辑
    - _需求: 5.2, 5.3, 5.4_

- [ ] 6. 实现多药店库存管理
  - [ ] 6.1 创建库存数据模型
    - 创建DrugInventory结构体和数据库表
    - 实现InventoryRepo接口定义
    - 添加库存状态枚举和预警机制
    - _需求: 6.1, 6.4_

  - [ ] 6.2 实现基础库存操作
    - 创建GetInventory查询特定药店库存方法
    - 实现UpdateInventory更新库存数量方法
    - 添加库存预留和释放功能(ReserveInventory, ReleaseReservedInventory)
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 6.3 实现库存预警和批量操作
    - 创建ListLowStockItems获取低库存商品
    - 实现BulkUpdateInventory批量更新库存
    - 添加库存预警通知机制
    - _需求: 6.4, 6.5_

- [ ] 7. 实现数据一致性保障
  - [ ] 7.1 创建数据同步服务
    - 实现MySQL数据变更监听机制
    - 创建ES数据同步补偿逻辑
    - 添加同步失败重试和错误处理
    - _需求: 7.1, 7.2_

  - [ ] 7.2 实现数据一致性检查
    - 创建数据一致性验证方法
    - 实现数据修复和同步状态监控
    - 添加同步延迟告警机制
    - _需求: 7.3, 7.4, 7.5_

- [ ] 8. 更新现有Drug服务集成新功能
  - [ ] 8.1 扩展DrugService添加搜索功能
    - 在biz/drug.go中添加搜索相关方法
    - 更新DrugRepo接口包含ES搜索方法
    - 修改data/drug.go实现新的搜索逻辑
    - _需求: 1.3, 1.4_

  - [ ] 8.2 更新Drug API接口
    - 扩展现有drug.proto添加搜索相关接口
    - 实现搜索API的service层方法
    - 添加热门搜索和统计API端点
    - _需求: 2.3, 3.3, 4.3_

  - [ ] 8.3 集成处方和库存管理API
    - 添加处方管理相关的proto定义和API
    - 实现库存查询和管理的API接口
    - 更新HTTP路由包含新的API端点
    - _需求: 5.1, 5.2, 6.1, 6.2_

- [ ] 9. 实现搜索降级和容错机制
  - [ ] 9.1 实现搜索降级策略
    - 创建ES不可用时的MySQL搜索降级逻辑
    - 实现搜索超时和错误处理
    - 添加服务健康检查和熔断机制
    - _需求: 1.5, 7.2_

  - [ ] 9.2 实现缓存容错和重试机制
    - 添加Redis不可用时的功能降级
    - 实现数据同步的指数退避重试
    - 创建错误日志和监控告警
    - _需求: 7.2, 7.5_

- [ ] 10. 编写测试用例
  - [ ] 10.1 编写单元测试
    - 为所有Repository接口创建mock测试
    - 测试搜索算法和热度计算逻辑
    - 验证数据转换和验证逻辑
    - _需求: 所有需求的验证_

  - [ ] 10.2 编写集成测试
    - 创建ES集成测试验证搜索功能
    - 测试Redis统计功能的准确性
    - 验证数据库事务和一致性
    - _需求: 所有需求的集成验证_

- [ ] 11. 删除search目录并迁移功能
  - 将现有search模块的有用代码迁移到drug模块
  - 删除api/search目录和相关文件
  - 更新依赖注入配置移除search相关组件
  - _需求: 项目结构整理_