# 支付宝沙箱配置说明

## 1. 获取配置信息

### 1.1 访问支付宝开放平台
1. 访问 [支付宝开放平台](https://open.alipay.com/)
2. 登录你的支付宝账号
3. 进入"开发者中心" -> "沙箱应用"

### 1.2 获取必要信息
在沙箱应用页面，你可以看到：

- **APPID**: 你的应用ID（类似：9021000140671234）
- **支付宝网关地址**: `https://openapi.alipaydev.com/gateway.do`
- **RSA2(SHA256)密钥**: 需要配置应用公私钥对

## 2. 当前配置状态

### 2.1 已配置项目
✅ **应用私钥**: 已使用你提供的私钥  
✅ **支付宝公钥**: 已使用你提供的公钥  
✅ **沙箱环境**: 已配置为沙箱模式  

### 2.2 需要你提供的信息
❌ **APPID**: 请提供你的沙箱应用ID

## 3. 配置文件位置

配置信息在以下文件中：
- `kratos_client/comment/alipay.go` - 第32行的 `AppID` 字段

## 4. 测试账号

### 4.1 沙箱买家账号
在支付宝开放平台的沙箱应用页面，你可以看到：
- **买家账号**: 用于测试支付的账号
- **登录密码**: 买家账号的登录密码
- **支付密码**: 买家账号的支付密码

### 4.2 沙箱卖家账号
- **卖家账号**: 用于接收款项的账号
- **登录密码**: 卖家账号的登录密码

## 5. 测试流程

### 5.1 启动服务
```bash
cd kratos_client
make build
./bin/kratos_client.exe -conf ./configs/config.yaml
```

### 5.2 访问测试页面
打开浏览器访问：`http://localhost:8000/payment_test.html`

### 5.3 创建测试订单
1. 填写用户Token（使用之前生成的JWT token）
2. 填写商品信息和金额
3. 点击"创建支付订单"
4. 点击生成的支付链接

### 5.4 完成支付测试
1. 在支付宝沙箱页面使用沙箱买家账号登录
2. 使用沙箱支付密码完成支付
3. 支付完成后会跳转回你的应用

## 6. API接口说明

### 6.1 创建支付订单
```
POST /v1/payment/create
Content-Type: application/json

{
  "token": "用户JWT token",
  "subject": "商品标题",
  "total_amount": "0.01",
  "order_type": "drug_order",
  "business_id": "业务ID",
  "description": "订单描述"
}
```

### 6.2 查询支付状态
```
GET /v1/payment/query?order_id=订单号&token=用户token
```

### 6.3 支付回调地址
- **异步通知**: `http://localhost:8000/v1/payment/notify`
- **同步返回**: `http://localhost:8000/v1/payment/return`

## 7. 注意事项

### 7.1 网络要求
- 支付宝回调需要公网可访问的地址
- 本地测试可以使用内网穿透工具（如ngrok）

### 7.2 金额限制
- 沙箱环境支付金额建议使用0.01元进行测试
- 生产环境需要使用实际金额

### 7.3 证书和密钥
- 请妥善保管你的应用私钥
- 不要将私钥提交到代码仓库
- 生产环境建议使用环境变量或配置文件管理密钥

## 8. 常见问题

### 8.1 签名验证失败
- 检查应用私钥是否正确
- 检查支付宝公钥是否正确
- 确认使用的是RSA2(SHA256)签名方式

### 8.2 回调地址无法访问
- 确保回调地址可以从公网访问
- 检查防火墙和端口配置
- 本地测试可以使用ngrok等工具

### 8.3 订单查询失败
- 检查订单号是否正确
- 确认用户权限
- 查看服务器日志获取详细错误信息

## 9. 下一步

请提供你的支付宝沙箱APPID，我将更新配置文件，然后你就可以开始测试支付功能了。

APPID格式类似：`9021000140671234`